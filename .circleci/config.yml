version: 2.1

orbs:
  windows: circleci/windows@5.0
  general-platform-helpers: okta/general-platform-helpers@1.9

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build:
    executor:
      name: windows/default
    environment:
      CIRCLE_CI: True
    steps:
      - run:
          name: Manual HTTPS checkout (avoid SSH)
          command: |
            git --version
            if (Test-Path .git) { Remove-Item -Recurse -Force .git }
            git init .
            git remote add origin https://github.com/$env:CIRCLE_PROJECT_USERNAME/$env:CIRCLE_PROJECT_REPONAME.git
            git fetch --depth=1 origin $env:CIRCLE_SHA1
            git checkout --force $env:CIRCLE_SHA1
      - run:
          name: "build okta aspnet"
          command: .\build.ps1
      - persist_to_workspace: # Share code, git metadata, and build artifacts for Snyk scan
          root: ~/project
          paths:
            - .git
            - artifacts
            - Okta.AspNet
            - Okta.AspNet.Abstractions
            - Okta.AspNet.Abstractions.Test
            - Okta.AspNet.Test
            - Okta.AspNetCore
            - Okta.AspNetCore.Mvc.IntegrationTest
            - Okta.AspNetCore.Test
            - Okta.AspNetCore.WebApi.IntegrationTest
            - Okta.AspNet.WebApi.IntegrationTest
            - packages
            - tools
            - Okta.AspNet.sln
      - when:
          condition:
            equal: [ "<<pipeline.git.branch>>", "master" ]
          steps:
            - general-platform-helpers/step-artifacts-prepare-and-upload-windows:
                files-to-upload: "artifacts"
                location: "com/okta/devex/okta-aspnet"

  # Snyk Software Composition Analysis (SCA) scan on Windows to support net48/packages.config
  snyk-scan:
    executor:
      name: windows/default
    working_directory: ~/project
    environment:
      SNYK_DISABLE_ANALYTICS: "1"
    steps:
      - attach_workspace:
          at: ~/project
      - run:
          name: Download Snyk CLI (Windows standalone)
          command: |
            $ErrorActionPreference = 'Stop'
            $snykDir = Join-Path $env:USERPROFILE 'snyk'
            New-Item -ItemType Directory -Force -Path $snykDir | Out-Null
            $snykExe = Join-Path $snykDir 'snyk.exe'
            Invoke-WebRequest -UseBasicParsing -Uri 'https://static.snyk.io/cli/latest/snyk-win.exe' -OutFile $snykExe
            & $snykExe --version
      - run:
          name: Run Snyk monitor (Windows; exclude tools and packages only)
          command: |
            $ErrorActionPreference = 'Stop'
            $env:SNYK_DISABLE_ANALYTICS = "1"
            if (-not (Test-Path .git)) { Write-Error "No .git found"; exit 1 }
            $snykExe = Join-Path $env:USERPROFILE 'snyk/snyk.exe'
            $EXCLUDES = 'tools,packages'
            & $snykExe monitor `
              --all-projects `
              --detection-depth=4 `
              --prune-repeated-subdependencies `
              --exclude=$EXCLUDES

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  "Circle CI Build & Snyk Scan":
    jobs:
      - build
      - snyk-scan:
          name: execute-snyk
          context:
            - static-analysis
          requires:
            - build
